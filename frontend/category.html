<!doctype html>
<html lang="en" dir="ltr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CJG â€“ Category</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>

<header class="topnav">
  <div class="brand"><a href="index.html">CJG CUMONIDAD JUDIA</a></div>
  <div class="actions">
    <button class="icon" aria-label="Account">ğŸ§‘</button>
    <button class="icon" aria-label="Search">ğŸ”</button>
    <button class="icon" aria-label="Cart">ğŸ›ï¸</button>
  </div>
</header>

<main class="wrap">
  <aside class="side">
    <h2>Categories</h2>
    <div id="cats" class="cats"></div>
  </aside>

  <section class="content">
    <div class="controls">
      <input id="search" placeholder="Search by name / brand / location" />
      <span id="count"></span>
      <div class="pager">
        <button id="prev">â€¹ Prev</button>
        <button id="next">Next â€º</button>
      </div>
    </div>
    <div id="grid" class="grid"></div>
  </section>
</main>

<footer class="foot">Live data from API</footer>

<script>
  const API = "";
  let state = { q:"", category:null, offset:0, limit:24 };

  const el  = s => document.querySelector(s);
  const fmt = s => s || "â€”";

  function getParam(name){
    const u = new URL(location.href);
    return u.searchParams.get(name);
  }

  async function j(u){
    const r = await fetch(u);
    if(!r.ok) throw new Error(r.status + " " + r.statusText);
    return r.json();
  }

  async function loadCats(){
    const cats = await j(`${API}/api/categories`);
    const list = [{category:"All items", _all:true}].concat(cats);
    el("#cats").innerHTML = list.map(c => `
      <a class="chip ${state.category===(c._all? null : c.category) ? "active":""}"
         href="${c._all? `category.html` : `category.html?category=${encodeURIComponent(c.category)}`}">
        <span class="dot" style="--h:${Math.abs(c.category?.length*23)%360}"></span>
        ${c.category} ${c.count? `<span class="cnt">${c.count}</span>` : ""}
      </a>
    `).join("");
  }

  async function loadItems(){
    const p = new URLSearchParams();
    if(state.q)         p.set('q', state.q);
    if(state.category)  p.set('category', state.category);
    p.set('limit',  state.limit);
    p.set('offset', state.offset);
    return j(`${API}/api/items?${p}`);
  }

  function imgTag(src, alt){
    if(!src) return `<div class="thumb ph">No image</div>`;
    return `<img class="thumb" src="${src}" alt="${alt||""}" loading="lazy"
      onerror="this.replaceWith(Object.assign(document.createElement('div'),{className:'thumb ph',innerText:'No image'}))">`;
  }

  async function render(){
    el("#grid").innerHTML = '<div class="loading">Loadingâ€¦</div>';
    try{
      const data = await loadItems();
      el("#count").textContent = `${data.total} items`;
      const html = data.items.map(it => `
        <article class="card">
          <div class="thumb-wrap">${imgTag(it.Image, it.Name)}</div>
          <div class="body">
            <h3 class="name" title="${it.Name||''}">${fmt(it.Name)}</h3>
            <div class="meta">
              <span>Category: ${fmt(it.Category)}</span>
              <span>Brand: ${fmt(it.Marca)}</span>
              <span>Location: ${fmt(it.where)}</span>
            </div>
          </div>
        </article>
      `).join("");
      el("#grid").innerHTML = html || '<div class="empty">No results</div>';
      el("#prev").disabled = state.offset<=0;
      el("#next").disabled = state.offset+state.limit>=data.total;
    }catch(e){
      el("#grid").innerHTML = `<div class="error">Load error (${e.message})</div>`;
    }
  }

  document.addEventListener("input", e=>{
    if(e.target.id==="search"){
      state.q = e.target.value.trim();
      state.offset = 0;
      render();
    }
  });
  document.getElementById("prev").onclick = ()=>{ state.offset = Math.max(0, state.offset - state.limit); render(); };
  document.getElementById("next").onclick = ()=>{ state.offset += state.limit; render(); };

  (async function init(){
    state.category = getParam('category');
    await loadCats();
    await render();
  })();
</script>
</body>
</html>
